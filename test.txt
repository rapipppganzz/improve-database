-- FE Magnet Parts System - Fixed Version
-- Parts physically move to player - All Players Visible

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

-- Configuration
local CONFIG = {
    MagnetPower = 10, -- Kecepatan mendekat
    MagnetRange = 30, -- Jarak magnet aktif
    AttractSpeed = 0.5, -- Kecepatan tween
    Blacklist = {"Baseplate", "Terrain", "SpawnLocation", "Floor"} -- Part yang tidak tertarik
}

-- System Variables
local isMagnetActive = false
local attractedParts = {}
local magnetConnections = {}
local floatingButton

-- Check if part should be attracted
local function shouldAttractPart(part)
    -- Skip if part is in blacklist
    for _, blacklistedName in ipairs(CONFIG.Blacklist) do
        if string.find(string.lower(part.Name), string.lower(blacklistedName)) then
            return false
        end
    end
    
    -- Skip if part is too big (probably structural)
    if part.Size.Magnitude > 15 then
        return false
    end
    
    -- Skip if part is welded or anchored (probably important)
    if part.Anchored then
        return false
    end
    
    -- Skip if part is in player's character
    if part:IsDescendantOf(player.Character) then
        return false
    end
    
    -- Skip if already being attracted
    if attractedParts[part] then
        return false
    end
    
    return true
end

-- Find parts in range that can be attracted
local function findPartsInRange()
    local parts = {}
    local character = player.Character
    if not character then return parts end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return parts end
    
    local playerPosition = rootPart.Position
    
    for _, part in pairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") and shouldAttractPart(part) then
            local distance = (part.Position - playerPosition).Magnitude
            if distance <= CONFIG.MagnetRange then
                table.insert(parts, part)
            end
        end
    end
    
    return parts
end

-- Move part towards player using BodyVelocity (FE compatible)
local function attractPart(part)
    if not part or part.Parent == nil then return end
    
    local character = player.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    -- Mark as attracted
    attractedParts[part] = true
    
    -- Create BodyVelocity for smooth movement
    local bodyVelocity = Instance.new("BodyVelocity")
    bodyVelocity.Name = "MagnetVelocity"
    bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000) -- Reduced force for subtle movement
    bodyVelocity.Parent = part
    
    -- Create BodyGyro for stability
    local bodyGyro = Instance.new("BodyGyro")
    bodyGyro.Name = "MagnetGyro"
    bodyGyro.MaxTorque = Vector3.new(4000, 4000, 4000)
    bodyGyro.P = 1000
    bodyGyro.D = 100
    bodyGyro.Parent = part
    
    -- Movement loop
    local attractionThread = coroutine.create(function()
        while isMagnetActive and part and part.Parent and attractedParts[part] do
            local character = player.Character
            if not character then break end
            
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            if not rootPart then break end
            
            -- Calculate direction to player
            local direction = (rootPart.Position - part.Position).Unit
            local distance = (rootPart.Position - part.Position).Magnitude
            
            -- Stop if very close to player
            if distance < 3 then
                bodyVelocity.Velocity = Vector3.new(0, 0, 0)
                break
            end
            
            -- Move towards player
            bodyVelocity.Velocity = direction * CONFIG.MagnetPower
            
            -- Add slight floating effect
            local floatOffset = math.sin(tick() * 3) * 0.3
            bodyVelocity.Velocity = bodyVelocity.Velocity + Vector3.new(0, floatOffset, 0)
            
            RunService.Heartbeat:Wait()
        end
        
        -- Cleanup
        if bodyVelocity and bodyVelocity.Parent then
            bodyVelocity:Destroy()
        end
        if bodyGyro and bodyGyro.Parent then
            bodyGyro:Destroy()
        end
        attractedParts[part] = nil
    end)
    
    coroutine.resume(attractionThread)
end

-- Main magnet loop
local function startMagnetSystem()
    if isMagnetActive then return end
    
    isMagnetActive = true
    print("ðŸ§² Magnet system activated")
    
    local magnetLoop
    magnetLoop = RunService.Heartbeat:Connect(function()
        if not isMagnetActive or not player.Character then
            if magnetLoop then
                magnetLoop:Disconnect()
            end
            return
        end
        
        -- Find and attract new parts in range
        local partsInRange = findPartsInRange()
        for _, part in ipairs(partsInRange) do
            attractPart(part)
        end
    end)
    
    table.insert(magnetConnections, magnetLoop)
end

-- Stop magnet system
local function stopMagnetSystem()
    if not isMagnetActive then return end
    
    isMagnetActive = false
    print("âœ… Magnet system deactivated")
    
    -- Stop all movements
    for part, _ in pairs(attractedParts) do
        if part and part.Parent then
            local bodyVelocity = part:FindFirstChild("MagnetVelocity")
            if bodyVelocity then
                bodyVelocity:Destroy()
            end
            local bodyGyro = part:FindFirstChild("MagnetGyro")
            if bodyGyro then
                bodyGyro:Destroy()
            end
        end
    end
    
    -- Disconnect all connections
    for _, connection in ipairs(magnetConnections) do
        connection:Disconnect()
    end
    magnetConnections = {}
    
    -- Clear attracted parts
    attractedParts = {}
end

-- Create floating button when GUI is closed
local function createFloatingButton()
    floatingButton = Instance.new("TextButton")
    floatingButton.Name = "FloatingMagnetButton"
    floatingButton.Size = UDim2.new(0, 60, 0, 60)
    floatingButton.Position = UDim2.new(0, 20, 0, 20)
    floatingButton.BackgroundColor3 = Color3.fromRGB(0, 100, 255)
    floatingButton.Text = "ðŸ§²"
    floatingButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    floatingButton.TextSize = 20
    floatingButton.Font = Enum.Font.GothamBold
    floatingButton.Visible = false
    floatingButton.ZIndex = 10
    floatingButton.Parent = screenGui
    
    local floatingCorner = Instance.new("UICorner")
    floatingCorner.CornerRadius = UDim.new(1, 0)
    floatingCorner.Parent = floatingButton
    
    -- Add your custom logo here (replace the catbox.moe link)
    local logoImage = Instance.new("ImageLabel")
    logoImage.Size = UDim2.new(1, 0, 1, 0)
    logoImage.BackgroundTransparency = 1
    logoImage.Image = "https://files.catbox.moe/b0k250.jpg" -- Replace with your logo
    logoImage.Visible = false
    logoImage.Parent = floatingButton
    
    -- Drag functionality for floating button
    local floatingDragging = false
    local floatingDragInput, floatingDragStart, floatingStartPos
    
    local function updateFloating(input)
        local delta = input.Position - floatingDragStart
        floatingButton.Position = UDim2.new(floatingStartPos.X.Scale, floatingStartPos.X.Offset + delta.X, floatingStartPos.Y.Scale, floatingStartPos.Y.Offset + delta.Y)
    end
    
    floatingButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            floatingDragging = true
            floatingDragStart = input.Position
            floatingStartPos = floatingButton.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    floatingDragging = false
                end
            end)
        end
    end)
    
    floatingButton.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            floatingDragInput = input
        end
    end)
    
    game:GetService("UserInputService").InputChanged:Connect(function(input)
        if input == floatingDragInput and floatingDragging then
            updateFloating(input)
        end
    end)
    
    -- Show logo when clicked
    floatingButton.MouseButton1Click:Connect(function()
        logoImage.Visible = not logoImage.Visible
        if logoImage.Visible then
            floatingButton.Text = ""
            wait(3)
            logoImage.Visible = false
            floatingButton.Text = "ðŸ§²"
        end
    end)
    
    -- Double click to show main GUI
    local lastClickTime = 0
    floatingButton.MouseButton1Click:Connect(function()
        local currentTime = tick()
        if currentTime - lastClickTime < 0.5 then
            -- Double click detected
            mainFrame.Visible = true
            floatingButton.Visible = false
        end
        lastClickTime = currentTime
    end)
end

-- Create GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "MagnetSystemGUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player.PlayerGui

-- Main Frame with Dark Blue Theme
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 280, 0, 200)
mainFrame.Position = UDim2.new(0, 50, 0, 50)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 25, 45) -- Dark blue background
mainFrame.BorderSizePixel = 1
mainFrame.BorderColor3 = Color3.fromRGB(0, 100, 255) -- Blue stroke
mainFrame.Parent = screenGui

local mainCorner = Instance.new("UICorner")
mainCorner.CornerRadius = UDim.new(0, 12)
mainCorner.Parent = mainFrame

-- Title Bar
local titleBar = Instance.new("TextButton")
titleBar.Size = UDim2.new(1, 0, 0, 40)
titleBar.BackgroundColor3 = Color3.fromRGB(0, 80, 200) -- Darker blue
titleBar.BorderSizePixel = 0
titleBar.Text = ""
titleBar.AutoButtonColor = false
titleBar.Parent = mainFrame

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -50, 1, 0)
title.Position = UDim2.new(0, 10, 0, 0)
title.BackgroundTransparency = 1
title.Text = "ðŸ§² Part Magnet"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextSize = 16
title.Font = Enum.Font.GothamBold
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = titleBar

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Position = UDim2.new(1, -35, 0.5, -15)
closeBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 255) -- Blue
closeBtn.Text = "âœ•"
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.TextSize = 14
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Parent = titleBar

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 6)
closeCorner.Parent = closeBtn

-- Content Frame
local contentFrame = Instance.new("Frame")
contentFrame.Size = UDim2.new(1, 0, 1, -40)
contentFrame.Position = UDim2.new(0, 0, 0, 40)
contentFrame.BackgroundTransparency = 1
contentFrame.Parent = mainFrame

-- Status Display
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 60)
statusLabel.Position = UDim2.new(0, 10, 0, 10)
statusLabel.BackgroundColor3 = Color3.fromRGB(25, 35, 65) -- Dark blue
statusLabel.BorderColor3 = Color3.fromRGB(0, 100, 255) -- Blue stroke
statusLabel.BorderSizePixel = 1
statusLabel.Text = "ðŸ”´ Magnet: OFF\nParts move slowly towards you\nFE - Visible to all players"
statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
statusLabel.TextSize = 12
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextXAlignment = Enum.TextXAlignment.Left
statusLabel.TextYAlignment = Enum.TextYAlignment.Top
statusLabel.TextWrapped = true
statusLabel.Parent = contentFrame

local statusCorner = Instance.new("UICorner")
statusCorner.CornerRadius = UDim.new(0, 8)
statusCorner.Parent = statusLabel

-- Control Buttons
local activateBtn = Instance.new("TextButton")
activateBtn.Size = UDim2.new(1, -20, 0, 40)
activateBtn.Position = UDim2.new(0, 10, 0, 80)
activateBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255) -- Bright blue
activateBtn.BorderColor3 = Color3.fromRGB(0, 100, 255)
activateBtn.BorderSizePixel = 1
activateBtn.Text = "ðŸ§² ACTIVATE MAGNET"
activateBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
activateBtn.TextSize = 14
activateBtn.Font = Enum.Font.GothamBold
activateBtn.Parent = contentFrame

local activateCorner = Instance.new("UICorner")
activateCorner.CornerRadius = UDim.new(0, 8)
activateCorner.Parent = activateBtn

local deactivateBtn = Instance.new("TextButton")
deactivateBtn.Size = UDim2.new(1, -20, 0, 40)
deactivateBtn.Position = UDim2.new(0, 10, 0, 130)
deactivateBtn.BackgroundColor3 = Color3.fromRGB(40, 60, 100) -- Dark blue
activateBtn.BorderColor3 = Color3.fromRGB(0, 100, 255)
activateBtn.BorderSizePixel = 1
deactivateBtn.Text = "âœ… STOP MAGNET"
deactivateBtn.TextColor3 = Color3.fromRGB(200, 200, 200)
deactivateBtn.TextSize = 14
deactivateBtn.Font = Enum.Font.GothamBold
deactivateBtn.Parent = contentFrame

local deactivateCorner = Instance.new("UICorner")
deactivateCorner.CornerRadius = UDim.new(0, 8)
deactivateCorner.Parent = deactivateBtn

-- Button Functions
activateBtn.MouseButton1Click:Connect(function()
    startMagnetSystem()
    statusLabel.Text = "ðŸŸ¢ Magnet: ACTIVE\nParts moving towards you\nFE - All players can see"
    activateBtn.BackgroundColor3 = Color3.fromRGB(40, 60, 100)
    deactivateBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
end)

deactivateBtn.MouseButton1Click:Connect(function()
    stopMagnetSystem()
    statusLabel.Text = "ðŸ”´ Magnet: OFF\nParts move slowly towards you\nFE - Visible to all players"
    activateBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 255)
    deactivateBtn.BackgroundColor3 = Color3.fromRGB(40, 60, 100)
end)

closeBtn.MouseButton1Click:Connect(function()
    stopMagnetSystem()
    mainFrame.Visible = false
    if floatingButton then
        floatingButton.Visible = true
    end
end)

-- Create floating button
createFloatingButton()

-- Auto stop when character dies
player.CharacterAdded:Connect(function(character)
    character:WaitForChild("HumanoidRootPart")
    if isMagnetActive then
        wait(2)
        startMagnetSystem()
    end
end)

player.CharacterRemoving:Connect(function()
    stopMagnetSystem()
end)

-- Drag functionality for main GUI
local dragging = false
local dragInput, dragStart, startPos

local function update(input)
    local delta = input.Position - dragStart
    mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
end

titleBar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = mainFrame.Position
        
        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

titleBar.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
        dragInput = input
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

print("Magnet System Loaded!")
print("âœ… Parts physically move to player position")
print("ðŸ‘ï¸ All players can see the effect")
print("ðŸŽ¨ Dark blue theme with blue strokes")
print("ðŸ”§ Double click floating button to reopen GUI")