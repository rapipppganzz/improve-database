local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Config
_G.Config = _G.Config or {
    AutoWalk = false,
    WalkSpeed = 20,
    AutoJump = true,
    AntiVoid = true,
}

-- ========== MOBILE GUI ==========
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "RapipModsMobile"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- Cari parent yang work di Android
if gethui then
    ScreenGui.Parent = gethui()
elseif syn and syn.protect_gui then
    syn.protect_gui(ScreenGui)
    ScreenGui.Parent = game:GetService("CoreGui")
else
    ScreenGui.Parent = game:GetService("CoreGui")
end

-- Main Frame
local Main = Instance.new("Frame")
Main.Name = "Main"
Main.Parent = ScreenGui
Main.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Main.BackgroundTransparency = 0.1
Main.BorderColor3 = Color3.fromRGB(255, 0, 0)
Main.BorderSizePixel = 2
Main.Position = UDim2.new(0.05, 0, 0.3, 0)
Main.Size = UDim2.new(0, 280, 0, 320)
Main.Active = true
Main.Draggable = true

-- Title
local Title = Instance.new("TextLabel")
Title.Parent = Main
Title.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
Title.Size = UDim2.new(1, 0, 0, 45)
Title.Font = Enum.Font.GothamBold
Title.Text = "üî• RAPIPMODS üî•"
Title.TextColor3 = Color3.fromRGB(255, 255, 255)
Title.TextSize = 20

-- Function: Create Button
local function createBtn(name, text, yPos, color)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Parent = Main
    btn.BackgroundColor3 = color or Color3.fromRGB(50, 50, 50)
    btn.BorderSizePixel = 1
    btn.BorderColor3 = Color3.fromRGB(80, 80, 80)
    btn.Position = UDim2.new(0.05, 0, yPos, 0)
    btn.Size = UDim2.new(0.9, 0, 0, 38)
    btn.Font = Enum.Font.Gotham
    btn.Text = text
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.TextSize = 14
    btn.TextWrapped = true
    btn.AutoButtonColor = true
    
    return btn
end

-- Auto Walk Button
local walkBtn = createBtn("Walk", "üö∂ Auto Walk: OFF", 0.16)
walkBtn.MouseButton1Click:Connect(function()
    _G.Config.AutoWalk = not _G.Config.AutoWalk
    
    if _G.Config.AutoWalk then
        walkBtn.Text = "üö∂ Auto Walk: ON"
        walkBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
        print("[RAPIPMODS] Walk: ON")
    else
        walkBtn.Text = "üö∂ Auto Walk: OFF"
        walkBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
        print("[RAPIPMODS] Walk: OFF")
    end
end)

-- Speed Label
local speedLbl = Instance.new("TextLabel")
speedLbl.Parent = Main
speedLbl.BackgroundTransparency = 1
speedLbl.Position = UDim2.new(0.05, 0, 0.3, 0)
speedLbl.Size = UDim2.new(0.9, 0, 0, 20)
speedLbl.Font = Enum.Font.Gotham
speedLbl.Text = "‚ö° Speed: " .. _G.Config.WalkSpeed
speedLbl.TextColor3 = Color3.fromRGB(255, 255, 0)
speedLbl.TextSize = 13

-- Speed Buttons
local speedDown = createBtn("SpeedDown", "‚ûñ Speed", 0.38)
speedDown.Size = UDim2.new(0.43, 0, 0, 35)

local speedUp = createBtn("SpeedUp", "‚ûï Speed", 0.38)
speedUp.Position = UDim2.new(0.52, 0, 0.38, 0)
speedUp.Size = UDim2.new(0.43, 0, 0, 35)

speedDown.MouseButton1Click:Connect(function()
    _G.Config.WalkSpeed = math.max(16, _G.Config.WalkSpeed - 5)
    speedLbl.Text = "‚ö° Speed: " .. _G.Config.WalkSpeed
    if humanoid then
        humanoid.WalkSpeed = _G.Config.WalkSpeed
    end
end)

speedUp.MouseButton1Click:Connect(function()
    _G.Config.WalkSpeed = math.min(100, _G.Config.WalkSpeed + 5)
    speedLbl.Text = "‚ö° Speed: " .. _G.Config.WalkSpeed
    if humanoid then
        humanoid.WalkSpeed = _G.Config.WalkSpeed
    end
end)

-- Auto Jump Button
local jumpBtn = createBtn("Jump", "ü¶ò Auto Jump: ON", 0.53, Color3.fromRGB(0, 140, 0))
jumpBtn.MouseButton1Click:Connect(function()
    _G.Config.AutoJump = not _G.Config.AutoJump
    
    if _G.Config.AutoJump then
        jumpBtn.Text = "ü¶ò Auto Jump: ON"
        jumpBtn.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
    else
        jumpBtn.Text = "‚ùå Auto Jump: OFF"
        jumpBtn.BackgroundColor3 = Color3.fromRGB(140, 0, 0)
    end
end)

-- Anti Void Button
local voidBtn = createBtn("Void", "üõ°Ô∏è Anti Void: ON", 0.66, Color3.fromRGB(0, 140, 0))
voidBtn.MouseButton1Click:Connect(function()
    _G.Config.AntiVoid = not _G.Config.AntiVoid
    
    if _G.Config.AntiVoid then
        voidBtn.Text = "üõ°Ô∏è Anti Void: ON"
        voidBtn.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
    else
        voidBtn.Text = "‚ùå Anti Void: OFF"
        voidBtn.BackgroundColor3 = Color3.fromRGB(140, 0, 0)
    end
end)

-- Status
local status = Instance.new("TextLabel")
status.Parent = Main
status.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
status.BorderSizePixel = 0
status.Position = UDim2.new(0.05, 0, 0.78, 0)
status.Size = UDim2.new(0.9, 0, 0, 42)
status.Font = Enum.Font.Gotham
status.Text = "üìä Idle"
status.TextColor3 = Color3.fromRGB(0, 255, 150)
status.TextSize = 12
status.TextWrapped = true

-- Close Button
local closeBtn = Instance.new("TextButton")
closeBtn.Parent = Main
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeBtn.BorderSizePixel = 0
closeBtn.Position = UDim2.new(0.88, 0, 0.01, 0)
closeBtn.Size = UDim2.new(0, 30, 0, 30)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
closeBtn.TextSize = 16

closeBtn.MouseButton1Click:Connect(function()
    _G.Config.AutoWalk = false
    ScreenGui:Destroy()
    print("[RAPIPMODS] Closed")
end)

-- ========== FIXED AUTO WALK SYSTEM ==========
local function checkObstacle()
    if not rootPart then return false end
    
    local rayOrigin = rootPart.Position
    local rayDirection = rootPart.CFrame.LookVector * 6
    local ray = Ray.new(rayOrigin, rayDirection)
    
    local ignoreList = {character, unpack(workspace:GetDescendants())}
    local hit, position = workspace:FindPartOnRayWithIgnoreList(ray, ignoreList)
    
    return hit and hit.CanCollide
end

-- Improved main loop
local walkConnection
walkConnection = RunService.Heartbeat:Connect(function()
    pcall(function()
        -- Update character references jika needed
        if not character or not character.Parent then
            character = player.Character
            if character then
                humanoid = character:FindFirstChildOfClass("Humanoid")
                rootPart = character:FindFirstChild("HumanoidRootPart")
            end
        end
        
        if character and humanoid and rootPart then
            -- Apply walk speed
            humanoid.WalkSpeed = _G.Config.WalkSpeed
            
            -- Auto Walk System
            if _G.Config.AutoWalk then
                humanoid:Move(Vector3.new(0, 0, -1)) -- Maju terus
                
                -- Auto Jump jika ada halangan
                if _G.Config.AutoJump and checkObstacle() then
                    humanoid.Jump = true
                end
                
                -- Anti Void system
                if _G.Config.AntiVoid then
                    local yPos = rootPart.Position.Y
                    if yPos < -50 then
                        -- Teleport ke tempat aman
                        local safeCFrame = CFrame.new(0, 50, 0)
                        rootPart.CFrame = safeCFrame
                        humanoid.Jump = true
                    end
                end
                
                -- Update status
                local height = math.floor(rootPart.Position.Y)
                status.Text = "üìä Walking | Height: " .. height .. "m"
            else
                status.Text = "üìä Idle | Height: " .. math.floor(rootPart.Position.Y) .. "m"
            end
        else
            status.Text = "üìä Waiting for character..."
        end
    end)
end)

-- ========== IMPROVED RESPAWN HANDLER ==========
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    repeat task.wait() until character:FindFirstChild("Humanoid") and character:FindFirstChild("HumanoidRootPart")
    
    humanoid = character:FindFirstChildOfClass("Humanoid")
    rootPart = character:FindFirstChild("HumanoidRootPart")
    
    print("[RAPIPMODS] Character respawned - References updated")
end)

-- ========== MOBILE OPTIMIZATION ==========
-- Make buttons more responsive for touch
for _, button in pairs(Main:GetChildren()) do
    if button:IsA("TextButton") then
        button.MouseButton1Down:Connect(function()
            button.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        end)
        
        button.MouseButton1Up:Connect(function()
            task.wait(0.1)
            if button == walkBtn and _G.Config.AutoWalk then
                button.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
            elseif button == jumpBtn and _G.Config.AutoJump then
                button.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
            elseif button == voidBtn and _G.Config.AntiVoid then
                button.BackgroundColor3 = Color3.fromRGB(0, 140, 0)
            else
                button.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            end
        end)
    end
end

-- ========== NOTIFICATION ==========
print("========================================")
print("üî• RAPIPMODS - Delta Android FIXED")
print("‚úÖ Auto Walk System Fixed")
print("‚úÖ Mobile GUI Optimized") 
print("‚úÖ Anti Void & Auto Jump Working")
print("========================================")

-- Cleanup ketika GUI dihapus
ScreenGui.Destroying:Connect(function()
    if walkConnection then
        walkConnection:Disconnect()
    end
    _G.Config.AutoWalk = false
end)