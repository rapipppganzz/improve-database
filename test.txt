--[[
    ðŸ”ï¸ AUTO MOUNTAIN CLIMBER - GUI FIXED
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local PathfindingService = game:GetService("PathfindingService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Config
_G.Config = _G.Config or {
    Enabled = false,
    WalkSpeed = 25,
    AutoJump = true,
    SearchRadius = 100,
    SearchHeight = 200,
    TargetPosition = nil
}

-- ========== AUTO TARGET FINDER ==========
local function findHighestPoint()
    print("ðŸ” Mencari titik tertinggi di area...")
    
    local bestPosition = nil
    local highestY = -math.huge
    
    local scanRadius = _G.Config.SearchRadius
    local center = rootPart.Position
    
    for x = -scanRadius, scanRadius, 20 do
        for z = -scanRadius, scanRadius, 20 do
            local scanPos = Vector3.new(center.X + x, center.Y + _G.Config.SearchHeight, center.Z + z)
            local ray = Ray.new(scanPos, Vector3.new(0, -_G.Config.SearchHeight * 2, 0))
            local hit, position = workspace:FindPartOnRayWithIgnoreList(ray, {character})
            
            if hit and position.Y > highestY then
                highestY = position.Y
                bestPosition = position
            end
        end
    end
    
    if bestPosition then
        print("ðŸŽ¯ Titik tertinggi ditemukan: " .. tostring(bestPosition))
    else
        local finishParts = {"Finish", "End", "Goal", "Win", "Complete", "EndPoint", "FinishLine", "Victory"}
        for _, partName in ipairs(finishParts) do
            local part = workspace:FindFirstChild(partName)
            if part then
                bestPosition = part.Position
                print("ðŸŽ¯ Finish part ditemukan: " .. partName)
                break
            end
        end
    end
    
    return bestPosition
end

local function findPathToTarget()
    if not _G.Config.TargetPosition then
        _G.Config.TargetPosition = findHighestPoint()
        
        if not _G.Config.TargetPosition then
            local randomPos = rootPart.Position + Vector3.new(
                math.random(-50, 50),
                math.random(10, 30),
                math.random(-50, 50)
            )
            _G.Config.TargetPosition = randomPos
            print("ðŸ” Explore random position")
        end
    end
    
    return _G.Config.TargetPosition
end

-- ========== SMART NAVIGATION ==========
local path = nil
local waypoints = nil
local currentWaypointIndex = 0
local lastStuckCheck = os.time()
local lastPosition = rootPart.Position

local function computePath(targetPosition)
    if not PathfindingService then 
        return {{Position = targetPosition, Action = Enum.PathWaypointAction.Walk}}
    end
    
    local success, result = pcall(function()
        path = PathfindingService:CreatePath({
            AgentRadius = 2,
            AgentHeight = 5,
            AgentCanJump = true,
            WaypointSpacing = 6
        })
        
        path:ComputeAsync(rootPart.Position, targetPosition)
        
        if path.Status == Enum.PathStatus.Success then
            return path:GetWaypoints()
        else
            print("âš ï¸ Pathfinding gagal, menggunakan direct movement")
            return {{Position = targetPosition, Action = Enum.PathWaypointAction.Walk}}
        end
    end)
    
    return success and result or {{Position = targetPosition, Action = Enum.PathWaypointAction.Walk}}
end

local function moveToWaypoint()
    if not waypoints or currentWaypointIndex > #waypoints then
        return false
    end
    
    local waypoint = waypoints[currentWaypointIndex]
    local direction = (waypoint.Position - rootPart.Position).Unit
    
    humanoid:Move(direction)
    
    local distance = (rootPart.Position - waypoint.Position).Magnitude
    if distance < 5 then
        currentWaypointIndex = currentWaypointIndex + 1
    end
    
    if waypoint.Action == Enum.PathWaypointAction.Jump then
        humanoid.Jump = true
    end
    
    return currentWaypointIndex <= #waypoints
end

local function checkFrontObstacle()
    local rayOrigin = rootPart.Position + Vector3.new(0, 2, 0)
    local rayDirection = rootPart.CFrame.LookVector * 8
    local ray = Ray.new(rayOrigin, rayDirection)
    
    local hit, position = workspace:FindPartOnRayWithIgnoreList(ray, {character})
    return hit and hit.CanCollide
end

local function checkIfStuck()
    local currentTime = os.time()
    if currentTime - lastStuckCheck < 2 then return false end
    
    local currentPos = rootPart.Position
    local distanceMoved = (currentPos - lastPosition).Magnitude
    
    if distanceMoved < 2 then
        print("ðŸ”„ Karakter stuck, mencari path baru...")
        lastStuckCheck = currentTime
        return true
    end
    
    lastPosition = currentPos
    lastStuckCheck = currentTime
    return false
end

-- ========== MAIN BOT BRAIN ==========
local function smartNavigation()
    if not _G.Config.Enabled then return end
    
    if not character or not character.Parent then
        character = player.Character
        if character then
            humanoid = character:FindFirstChildOfClass("Humanoid")
            rootPart = character:FindFirstChild("HumanoidRootPart")
        end
        return
    end
    
    if not humanoid or not rootPart then return end
    
    humanoid.WalkSpeed = _G.Config.WalkSpeed
    
    if checkIfStuck() then
        waypoints = nil
        _G.Config.TargetPosition = nil
        humanoid.Jump = true
        task.wait(0.5)
    end
    
    if not _G.Config.TargetPosition then
        findPathToTarget()
    end
    
    if not waypoints or currentWaypointIndex > #waypoints then
        local target = findPathToTarget()
        waypoints = computePath(target)
        currentWaypointIndex = 1
        print("ðŸ”„ Computing path ke target...")
    end
    
    if waypoints and currentWaypointIndex <= #waypoints then
        if not moveToWaypoint() then
            print("âœ… Path selesai, mencari target baru...")
            waypoints = nil
            _G.Config.TargetPosition = nil
        end
    end
    
    if _G.Config.AutoJump and checkFrontObstacle() then
        humanoid.Jump = true
        task.wait(0.2)
    end
    
    if os.time() % 30 < 0.1 then
        _G.Config.TargetPosition = nil
        print("ðŸ”„ Auto re-targeting...")
    end
end

-- ========== FIXED GUI ==========
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "MountainClimber"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling -- Penting banget!

-- Coba berbagai method parenting untuk Android
local success, result = pcall(function()
    if gethui then
        ScreenGui.Parent = gethui()
    elseif syn and syn.protect_gui then
        syn.protect_gui(ScreenGui)
        ScreenGui.Parent = game:GetService("CoreGui")
    else
        ScreenGui.Parent = game:GetService("CoreGui")
    end
end)

if not success then
    ScreenGui.Parent = player:WaitForChild("PlayerGui")
end

-- Main Frame - UKURAN DIPERBESAR
local Main = Instance.new("Frame")
Main.Name = "MainFrame"
Main.Parent = ScreenGui
Main.Size = UDim2.new(0, 320, 0, 280) -- Diperbesar
Main.Position = UDim2.new(0.02, 0, 0.3, 0)
Main.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
Main.BackgroundTransparency = 0.1
Main.BorderSizePixel = 2
Main.BorderColor3 = Color3.fromRGB(0, 200, 255)
Main.Active = true
Main.Draggable = true
Main.ZIndex = 10

-- Title - PASTIKAN ZINDEX LEBIH TINGGI
local Title = Instance.new("TextLabel")
Title.Parent = Main
Title.Name = "Title"
Title.Text = "ðŸ”ï¸ MOUNTAIN CLIMBER"
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
Title.TextColor3 = Color3.white
Title.Font = Enum.Font.GothamBold
Title.TextSize = 18
Title.ZIndex = 11
Title.BorderSizePixel = 0

-- Function untuk bikin button yang pasti kelihatan
local function createVisibleButton(name, text, yPos, color)
    local btn = Instance.new("TextButton")
    btn.Name = name
    btn.Parent = Main
    btn.Size = UDim2.new(0.9, 0, 0, 40)
    btn.Position = UDim2.new(0.05, 0, yPos, 0)
    btn.BackgroundColor3 = color or Color3.fromRGB(60, 60, 60)
    btn.BorderSizePixel = 1
    btn.BorderColor3 = Color3.fromRGB(100, 100, 100)
    btn.Text = text
    btn.TextColor3 = Color3.white
    btn.Font = Enum.Font.Gotham
    btn.TextSize = 14
    btn.ZIndex = 11
    btn.AutoButtonColor = true
    return btn
end

-- Start/Stop Button - POSISI DIPASTIKAN
local toggleBtn = createVisibleButton("ToggleBtn", "ðŸš€ START CLIMBING", 0.18, Color3.fromRGB(0, 150, 0))

-- Speed Controls
local speedDown = createVisibleButton("SpeedDown", "âž– SPEED", 0.38, Color3.fromRGB(200, 100, 0))
speedDown.Size = UDim2.new(0.4, 0, 0, 35)

local speedUp = createVisibleButton("SpeedUp", "âž• SPEED", 0.38, Color3.fromRGB(0, 100, 200))
speedUp.Position = UDim2.new(0.52, 0, 0.38, 0)
speedUp.Size = UDim2.new(0.4, 0, 0, 35)

-- Speed Label
local speedLbl = Instance.new("TextLabel")
speedLbl.Parent = Main
speedLbl.Name = "SpeedLabel"
speedLbl.Size = UDim2.new(0.9, 0, 0, 25)
speedLbl.Position = UDim2.new(0.05, 0, 0.55, 0)
speedLbl.BackgroundTransparency = 1
speedLbl.Text = "âš¡ Speed: " .. _G.Config.WalkSpeed
speedLbl.TextColor3 = Color3.fromRGB(255, 255, 0)
speedLbl.Font = Enum.Font.Gotham
speedLbl.TextSize = 14
speedLbl.ZIndex = 11

-- Status Display - DIPERBESAR
local statusLbl = Instance.new("TextLabel")
statusLbl.Parent = Main
statusLbl.Name = "StatusLabel"
statusLbl.Size = UDim2.new(0.9, 0, 0, 80)
statusLbl.Position = UDim2.new(0.05, 0, 0.68, 0)
statusLbl.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
statusLbl.BorderSizePixel = 1
statusLbl.BorderColor3 = Color3.fromRGB(80, 80, 80)
statusLbl.TextColor3 = Color3.fromRGB(0, 255, 150)
statusLbl.Font = Enum.Font.Gotham
statusLbl.TextSize = 12
statusLbl.TextWrapped = true
statusLbl.ZIndex = 11
statusLbl.Text = "ðŸ¤– Status: Ready\nðŸ“ Tekan START untuk mulai!"

-- Close Button - DIKECILKAN TAPI PASTI KELIHATAN
local closeBtn = Instance.new("TextButton")
closeBtn.Parent = Main
closeBtn.Name = "CloseBtn"
closeBtn.Size = UDim2.new(0, 25, 0, 25)
closeBtn.Position = UDim2.new(0.92, 0, 0.02, 0)
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
closeBtn.BorderSizePixel = 0
closeBtn.Text = "X"
closeBtn.TextColor3 = Color3.white
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 14
closeBtn.ZIndex = 12
closeBtn.AutoButtonColor = true

-- ========== BUTTON FUNCTIONALITY ==========
toggleBtn.MouseButton1Click:Connect(function()
    _G.Config.Enabled = not _G.Config.Enabled
    
    if _G.Config.Enabled then
        toggleBtn.Text = "ðŸ›‘ STOP CLIMBING"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
        _G.Config.TargetPosition = nil
        waypoints = nil
        print("ðŸ”ï¸ Mountain Climber: STARTED")
        statusLbl.Text = "ðŸ”ï¸ Sedang mendaki...\nðŸ” Mencari jalur..."
    else
        toggleBtn.Text = "ðŸš€ START CLIMBING"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 0)
        if humanoid then
            humanoid:Move(Vector3.new(0, 0, 0))
        end
        print("ðŸ”ï¸ Mountain Climber: STOPPED")
        statusLbl.Text = "ðŸ¤– Status: Ready\nðŸ“ Tekan START untuk mulai!"
    end
end)

speedUp.MouseButton1Click:Connect(function()
    _G.Config.WalkSpeed = math.min(50, _G.Config.WalkSpeed + 5)
    speedLbl.Text = "âš¡ Speed: " .. _G.Config.WalkSpeed
    if humanoid then
        humanoid.WalkSpeed = _G.Config.WalkSpeed
    end
end)

speedDown.MouseButton1Click:Connect(function()
    _G.Config.WalkSpeed = math.max(16, _G.Config.WalkSpeed - 5)
    speedLbl.Text = "âš¡ Speed: " .. _G.Config.WalkSpeed
    if humanoid then
        humanoid.WalkSpeed = _G.Config.WalkSpeed
    end
end)

closeBtn.MouseButton1Click:Connect(function()
    _G.Config.Enabled = false
    if humanoid then
        humanoid:Move(Vector3.new(0, 0, 0))
    end
    ScreenGui:Destroy()
    print("ðŸ”ï¸ Mountain Climber: Closed")
end)

-- ========== DEBUG: CHECK GUI VISIBILITY ==========
print("ðŸ” Checking GUI elements...")
for i, child in ipairs(Main:GetChildren()) do
    print("âœ… GUI Element: " .. child.Name .. " | Type: " .. child.ClassName)
end

-- ========== MAIN LOOP ==========
local navigationConnection
navigationConnection = RunService.Heartbeat:Connect(function()
    if _G.Config.Enabled then
        local success, err = pcall(smartNavigation)
        if not success then
            print("âŒ Navigation error: " .. err)
            statusLbl.Text = "âŒ Error: " .. err
        end
        
        if _G.Config.TargetPosition and rootPart then
            local dist = math.floor((rootPart.Position - _G.Config.TargetPosition).Magnitude)
            local height = math.floor(rootPart.Position.Y)
            statusLbl.Text = "ðŸ”ï¸ Mendaki Gunung...\nðŸ“ Jarak target: " .. dist .. " studs\nðŸ“ Ketinggian: " .. height .. "m\nðŸŽ¯ Waypoint: " .. currentWaypointIndex
        end
    end
end)

-- ========== RESPAWN HANDLER ==========
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    task.wait(1)
    humanoid = character:WaitForChild("Humanoid")
    rootPart = character:WaitForChild("HumanoidRootPart")
    
    waypoints = nil
    currentWaypointIndex = 0
    _G.Config.TargetPosition = nil
    
    print("ðŸ”ï¸ Character respawned - Climber reset")
end)

-- Cleanup
ScreenGui.Destroying:Connect(function()
    if navigationConnection then
        navigationConnection:Disconnect()
    end
end)

print("========================================")
print("ðŸ”ï¸ AUTO MOUNTAIN CLIMBER LOADED")
print("âœ… GUI Fixed - Should be visible now!")
print("âœ… Auto Target Detection") 
print("âœ… No Manual Checkpoint Needed")
print("========================================")

-- Force show GUI (debug)
task.wait(1)
if Main and Main.Parent then
    print("ðŸŽ‰ GUI Successfully Loaded!")
    statusLbl.Text = "âœ… GUI Loaded!\nðŸ“ Tekan START untuk mulai!"
else
    print("âŒ GUI Failed to Load!")
end